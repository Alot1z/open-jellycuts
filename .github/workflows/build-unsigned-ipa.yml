name: Build Unsigned IPA

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app  # ← THIS PATH IS WRONG

      - name: Build app (Release, unsigned)
        run: |
          xcodebuild build \
            -project "Jellycuts.xcodeproj" \
            -scheme "Jellycuts" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            -derivedDataPath "${{ runner.workspace }}/DerivedData"

      - name: Create IPA from app bundle
        run: |
          # 1. Find det compilede .app-bundle
          APP_PATH=$(find "${{ runner.workspace }}/DerivedData/Build/Products" -name "*.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: Could not find .app bundle!"
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          
          # 2. Opret en midlertidig Payload-mappe
          IPA_DIR="${{ runner.workspace }}/ipa"
          mkdir -p "$IPA_DIR/Payload"
          
          # 3. Kopier .app-bundlet til Payload/
          cp -R "$APP_PATH" "$IPA_DIR/Payload/"
          
          # 4. Gå ind i mappen og zip den
          cd "$IPA_DIR"
          zip -qr "Jellycuts.ipa" "Payload"
          
          # 5. Flyt den færdige .ipa til en central sti
          mv "Jellycuts.ipa" "${{ runner.workspace }}/"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jellycuts-unsigned-ipa
          path: ${{ runner.workspace }}/Jellycuts.ipa
          if-no-files-found: error